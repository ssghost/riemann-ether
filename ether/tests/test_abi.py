import unittest

from ether import abi


class TestABI(unittest.TestCase):

    def setUp(self):
        self.vectors = [
            (['bytes3[2]'], [[b'abc', b'def']], bytes.fromhex('61626300000000000000000000000000000000000000000000000000000000006465660000000000000000000000000000000000000000000000000000000000')),  # noqa: E501
            (['uint32', 'bool'], [69, True], bytes.fromhex('00000000000000000000000000000000000000000000000000000000000000450000000000000000000000000000000000000000000000000000000000000001')),  # noqa: E501
            (['uint32', 'bool'], [69, False], bytes.fromhex('00000000000000000000000000000000000000000000000000000000000000450000000000000000000000000000000000000000000000000000000000000000')),  # noqa: E501
            (['bytes', 'bool', 'uint[]'], [b'dave', True, [1, 2, 3]], bytes.fromhex('0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000464617665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003')),  # noqa: E501
            (['uint[][]', 'string[]'], [[[1, 2], [3]], ["one", "two", "three"]], bytes.fromhex('000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000036f6e650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000374776f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000057468726565000000000000000000000000000000000000000000000000000000')),  # noqa: E501
            (['address'], [f'0x{"11" * 20}'], bytes.fromhex('0000000000000000000000001111111111111111111111111111111111111111')),  # noqa: E501
            (['address', 'address'], [f'0x{"11" * 20}', f'0x{"22" * 20}'], bytes.fromhex('00000000000000000000000011111111111111111111111111111111111111110000000000000000000000002222222222222222222222222222222222222222')),  # noqa: E501
            (['bytes'], [b'\x12\x34'], bytes.fromhex('000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000021234000000000000000000000000000000000000000000000000000000000000')),  # noqa: E501
            (['bytes'], [bytes.fromhex('10000000000000000000000000000000000000000000000000000000000002')], bytes.fromhex('0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000001f1000000000000000000000000000000000000000000000000000000000000200')),  # noqa: E501
            (['bytes'], [bytes.fromhex('10000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000')], bytes.fromhex('0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000')),  # noqa: E501
            (['bytes', 'bytes'], [bytes.fromhex('10000000000000000000000000000000000000000000000000000000000002'), bytes.fromhex('0010000000000000000000000000000000000000000000000000000000000002')], bytes.fromhex('00000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000001f100000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200010000000000000000000000000000000000000000000000000000000000002')),  # noqa: E501
            (['int32', 'bytes', 'int32', 'bytes'], [5, bytes.fromhex('131a3afc00d1b1e3461b955e53fc866dcf303b3eb9f4c16f89e388930f48134b131a3afc00d1b1e3461b955e53fc866dcf303b3eb9f4c16f89e388930f48134b'), 3, bytes.fromhex('131a3afc00d1b1e3461b955e53fc866dcf303b3eb9f4c16f89e388930f48134b131a3afc00d1b1e3461b955e53fc866dcf303b3eb9f4c16f89e388930f48134b')], bytes.fromhex('00000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000040131a3afc00d1b1e3461b955e53fc866dcf303b3eb9f4c16f89e388930f48134b131a3afc00d1b1e3461b955e53fc866dcf303b3eb9f4c16f89e388930f48134b0000000000000000000000000000000000000000000000000000000000000040131a3afc00d1b1e3461b955e53fc866dcf303b3eb9f4c16f89e388930f48134b131a3afc00d1b1e3461b955e53fc866dcf303b3eb9f4c16f89e388930f48134b')),  # noqa: E501
            # ([], [], bytes.fromhex('')),  # noqa: E501
            # ([], [], bytes.fromhex('')),  # noqa: E501
            # ([], [], bytes.fromhex('')),  # noqa: E501
        ]

    def print_in_32s(self, a, b):
        from itertools import zip_longest
        a1 = [a[i:i+32].hex() for i in range(0, len(a), 32)]
        b1 = [b[i:i+32].hex() for i in range(0, len(b), 32)]
        for c in zip_longest(a1, b1):
            print(c)

    def test_roundtrip(self):
        for t in self.vectors:
            (types, args, expected_blob) = (t[0], t[1], t[2])

            blob = abi.encode_many(types, args)
            # self.print_in_32s(blob, expected_blob)
            self.assertEqual(blob, expected_blob)

            decoded = abi.decode_many(types, blob)
            self.assertEqual(decoded, args)

            re_blob = abi.encode_many(types, decoded)
            self.assertEqual(re_blob, blob)
